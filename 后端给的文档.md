# 农田助理应用 - 后端API接口文档

## 基础信息

- **数据格式**: 所有请求和响应均使用JSON格式
- **认证方式**: 登录成功后返回token，后续请求在Header中使用Bearer Token认证
- **Base URL**: `https://gwyixuidazse.sealosbja.site`

## 统一响应格式

所有API响应都遵循以下统一格式：

```json
{
  "success": true/false,  // 请求是否成功
  "code": 200,            // 状态码，成功时为200，失败时根据错误类型返回相应的错误码
  "message": "消息说明",   // 响应消息，成功或错误的描述信息
  "data": {               // 响应数据，成功时返回相关数据，失败时可为null
    // 具体数据字段
  }
}
```

## API接口

### 1. 用户账户管理相关API

#### 1.1 用户注册

##### 请求

- **URL**: `/auth/register`
- **方法**: `POST`
- **Content-Type**: `application/json`

##### 请求参数

```json
{
  "username": "用户名",
  "phone": "手机号",
  "password": "密码",
  "location": "位置信息（可选）",
  "farmArea": "农场面积（可选）"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "注册成功",
  "data": {
    "token": "用户认证令牌",
    "userInfo": {
      "id": "用户ID",
      "username": "用户名",
      "phone": "手机号",
      "location": "位置信息",
      "farmArea": 0,
      "createTime": 1672502400000,
      "updateTime": 1672502400000
    }
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 400,
  "message": "用户名或手机号已存在",
  "data": null
}
```

#### 1.2 用户登录

##### 请求

- **URL**: `/auth/login`
- **方法**: `POST`
- **Content-Type**: `application/json`

##### 请求参数

```json
{
  "username": "用户名或手机号",
  "password": "密码"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "用户认证令牌",
    "userInfo": {
      "id": "用户ID",
      "username": "用户名",
      "phone": "手机号",
      "location": "位置信息",
      "farmArea": 100,
      "createTime": 1672502400000,
      "updateTime": 1672502400000
    }
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "用户名或密码错误",
  "data": null
}
```

#### 1.3 发送短信验证码

##### 请求

- **URL**: `/auth/send-verification-code`
- **方法**: `POST`
- **Content-Type**: `application/json`

##### 请求参数

```json
{
  "phone": "手机号"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "验证码发送成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 400,
  "message": "手机号格式错误或发送过于频繁",
  "data": null
}
```

#### 1.4 重置密码

##### 请求

- **URL**: `/auth/reset-password`
- **方法**: `POST`
- **Content-Type**: `application/json`

##### 请求参数

```json
{
  "phone": "手机号",
  "code": "短信验证码",
  "password": "新密码"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "密码重置成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 400,
  "message": "验证码无效或已过期",
  "data": null
}
```

#### 1.5 修改密码

##### 请求

- **URL**: `/auth/change-password`
- **方法**: `POST`
- **Content-Type**: `application/json`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```json
{
  "oldPassword": "旧密码",
  "newPassword": "新密码"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "密码修改成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "用户未登录",
  "data": null
}
```

#### 1.6 登出

##### 请求

- **URL**: `/auth/logout`
- **方法**: `POST`
- **Authorization**: Bearer Token (必须)

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "登出成功",
  "data": null
}
```

### 2. 用户信息相关API

#### 2.1 获取个人信息

##### 请求

- **URL**: `/user/profile`
- **方法**: `GET`
- **Authorization**: Bearer Token (必须)

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": "用户ID",
    "username": "用户名",
    "phone": "手机号",
    "location": "位置信息",
    "farmArea": "100",
    "joinDate": "2023-01-01"
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

#### 2.2 更新用户信息

##### 请求

- **URL**: `/user/update-info`
- **方法**: `PUT`
- **Content-Type**: `application/json`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```json
{
  "username": "用户名（可选）",
  "location": "位置信息（可选）",
  "farmArea": "农场面积（可选）"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "用户信息更新成功",
  "data": {
    "id": "用户ID",
    "username": "更新后的用户名",
    "phone": "手机号",
    "location": "更新后的位置信息",
    "farmArea": "更新后的农场面积",
    "joinDate": "2023-01-01"
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

#### 2.3 使用验证码更新手机号

##### 请求

- **URL**: `/user/update-phone`
- **方法**: `PUT`
- **Content-Type**: `application/json`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```json
{
  "phone": "新手机号",
  "code": "短信验证码"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "手机号更新成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 400,
  "message": "验证码无效或已过期",
  "data": null
}
```

### 3. 农场管理相关API

#### 3.1 更新农场面积

##### 请求

- **URL**: `/farm/update-area`
- **方法**: `PUT`
- **Content-Type**: `application/json`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```json
{
  "farmArea": "100"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "农场面积更新成功",
  "data": {
    "farmArea": "100"
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

#### 3.2 获取农场信息

##### 请求

- **URL**: `/farm/info`
- **方法**: `GET`
- **Authorization**: Bearer Token (必须)

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": {
    "farmArea": 100,
    "plotTotalArea": 85,
    "plotCount": 2
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

#### 3.3 同步面积

##### 请求

- **URL**: `/farm/sync-area`
- **方法**: `POST`
- **Authorization**: Bearer Token (必须)

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "同步成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

### 4. 消息通知相关API

#### 4.1 获取消息通知列表

##### 请求

- **URL**: `/notifications`
- **方法**: `GET`
- **Authorization**: Bearer Token (必须)

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "id": "消息ID",
      "title": "欢迎使用农田助理",
      "content": "欢迎使用农田助理！在这里您将收到重要的系统通知和农田预警信息。",
      "time": "2023-01-01 12:00",
      "type": "system",
      "read": false
    }
  ]
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

#### 4.2 标记消息为已读

##### 请求

- **URL**: `/notifications/mark-read`
- **方法**: `PUT`
- **Content-Type**: `application/json`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```json
{
  "notificationId": "消息ID"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "标记成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 404,
  "message": "消息不存在",
  "data": null
}
```

#### 4.3 清空所有消息

##### 请求

- **URL**: `/notifications/clear-all`
- **方法**: `DELETE`
- **Authorization**: Bearer Token (必须)

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "清空成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

### 5. 摄像机监控相关API

#### 5.1 获取摄像头状态和流

##### 请求

- **URL**: `/camera/stream`
- **方法**: `GET`
- **Authorization**: Bearer Token (必须)

##### 成功响应（已连接）

```json
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": {
    "connected": true,
    "streamUrl": "rtsp://camera.example.com/stream/1",
    "message": "摄像头已连接",
    "deviceInfo": {
      "id": "CAM001",
      "name": "农田监控摄像头",
      "status": "online",
      "lastOnline": "2023-01-01 12:00:00"
    }
  }
}
```

##### 成功响应（未连接）

```json
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": {
    "connected": false,
    "streamUrl": "",
    "message": "摄像头未连接",
    "deviceInfo": {
      "id": "CAM001",
      "name": "农田监控摄像头",
      "status": "offline",
      "lastOnline": "2023-01-01 12:00:00"
    }
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

#### 5.2 连接摄像头

##### 请求

- **URL**: `/camera/connect`
- **方法**: `POST`
- **Content-Type**: `application/json`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```json
{
  "deviceId": "摄像头设备ID（可选）"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "连接成功",
  "data": {
    "streamUrl": "rtsp://camera.example.com/stream/1"
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 503,
  "message": "连接失败",
  "data": {
    "reason": "设备离线",
    "message": "摄像头设备当前不在线，请检查设备连接或联系客服"
  }
}
```

#### 5.3 获取AI检测历史记录

##### 请求

- **URL**: `/camera/ai-events`
- **方法**: `GET`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```
page: 页码（可选，默认1）
pageSize: 每页数量（可选，默认10）
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "id": "事件ID",
      "desc": "检测到农田东侧有动态",
      "type": "movement",
      "time": "2023-01-01 12:00:00",
      "read": false
    },
    {
      "id": "事件ID",
      "desc": "检测到农田南侧有动物",
      "type": "animal",
      "time": "2023-01-01 11:00:00",
      "read": false
    }
  ]
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

### 6. 作物智诊相关API

#### 6.1 分析作物图片

##### 请求

- **URL**: `/crop/analyze`
- **方法**: `POST`
- **Content-Type**: `multipart/form-data`
- **Authorization**: Bearer Token (必须)

##### 请求参数

- 文件名：`image`，文件类型：图片

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "分析成功",
  "data": {
    "analysisTime": "2023-01-01 12:00",
    "cropType": "水稻",
    "growthStage": "抽穗期",
    "healthStatus": "健康",
    "analysisDetail": "经AI分析，当前水稻处于抽穗期，整体生长状况良好，叶色浓绿，长势均匀，未发现明显病虫害迹象。",
    "suggestions": [
      "继续保持现有管理方式",
      "注意控制水分，保持稻田浅水层",
      "预计20天后可以收获"
    ]
  }
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 400,
  "message": "未提供图片或图片格式不支持",
  "data": null
}
```

#### 6.2 获取作物分析历史

##### 请求

- **URL**: `/crop/analysis-history`
- **方法**: `GET`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```
page: 页码（可选，默认1）
pageSize: 每页数量（可选，默认10）
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "id": "记录ID",
      "imagePath": "/crop/image/记录ID",
      "analysisTime": "2023-01-01 12:00",
      "savedAt": 1672502400000,
      "cropType": "水稻",
      "growthStage": "抽穗期",
      "healthStatus": "健康",
      "analysisDetail": "经AI分析，当前水稻处于抽穗期，整体生长状况良好，叶色浓绿，长势均匀，未发现明显病虫害迹象。",
      "suggestions": [
        "继续保持现有管理方式",
        "注意控制水分，保持稻田浅水层",
        "预计20天后可以收获"
      ]
    }
  ]
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

#### 6.3 删除作物分析历史记录

##### 请求

- **URL**: `/crop/analysis-record`
- **方法**: `DELETE`
- **Content-Type**: `application/json`
- **Authorization**: Bearer Token (必须)

##### 请求参数

```json
{
  "recordId": "记录ID"
}
```

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 404,
  "message": "记录不存在",
  "data": null
}
```

#### 6.4 清空所有作物分析历史

##### 请求

- **URL**: `/crop/clear-analysis-history`
- **方法**: `DELETE`
- **Authorization**: Bearer Token (必须)

##### 成功响应

```json
{
  "success": true,
  "code": 200,
  "message": "清空成功",
  "data": null
}
```

##### 失败响应

```json
{
  "success": false,
  "code": 401,
  "message": "未登录",
  "data": null
}
```

#### 6.5 获取作物图片

##### 请求

- **URL**: `/crop/image/{record_id}`
- **方法**: `GET`
- **Authorization**: Bearer Token (必须)

##### 成功响应

返回图片文件

##### 失败响应

```json
{
  "detail": "图片不存在"
}
```

## 错误码说明

| 错误码 | 说明 |
|-------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（未登录或token无效） |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 认证方式

除了注册、登录等特定接口外，所有请求都需要在请求头中包含授权令牌：

```
Authorization: Bearer <token>
```

## 接口调用示例

### 注册用户

```bash
curl -X POST https://gwyixuidazse.sealosbja.site/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"农田小助手","phone":"13812345678","password":"Password123","location":"山东省青岛市","farmArea":1000}'
```

### 用户登录

```bash
curl -X POST https://gwyixuidazse.sealosbja.site/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"13812345678","password":"Password123"}'
```

### 获取个人信息

```bash
curl -X GET https://gwyixuidazse.sealosbja.site/user/profile \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### 更新农场面积

```bash
curl -X PUT https://gwyixuidazse.sealosbja.site/farm/update-area \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{"farmArea":1200}'
```

### 获取消息通知

```bash
curl -X GET https://gwyixuidazse.sealosbja.site/notifications \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### 上传作物图片分析

```bash
curl -X POST https://gwyixuidazse.sealosbja.site/crop/analyze \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -F "image=@/path/to/crop_image.jpg"
``` 